## P2P 协议

P2P (Peer-to-Peer) 协议是一种计算机网络通信协议，它允许直接从一个节点（或对等体）到另一个节点之间的直接通信，而不需要中央服务器的介入。在 P2P 网络中，所有节点都是对等的，它们可以充当客户端和服务器，可以共享资源、提供服务和请求服务。

下面是 P2P 协议的一些重要特点和详细解释：

1. 对等体通信：在 P2P 网络中，节点之间可以直接通信，不需要依赖中央服务器。每个节点都可以充当客户端和服务器，可以请求和提供服务。

2. 分布式网络：P2P 网络是分布式的，没有中央控制节点。每个节点都存储一部分网络中的数据和资源，并且能够直接与其他节点交换数据。

3. 资源共享：P2P 网络的核心目标之一是实现资源共享。节点可以共享各种类型的资源，如文件、带宽、计算能力等。其他节点可以请求这些资源，并通过直接连接与提供资源的节点通信。

4. 自组织和自管理：P2P 网络是自组织的，节点可以动态地加入或离开网络，而不需要集中的管理机构。每个节点负责管理自己的连接和资源，并与其他节点进行协作。

5. 无需专用设备：P2P 网络不需要专门的服务器设备，所有的节点都可以提供服务和存储数据。这使得 P2P 网络更加灵活和可扩展。

6. 去中心化：P2P 网络没有中心化的架构，没有单点故障。即使有节点离线或失效，其他节点仍然可以继续工作并提供服务。

7. 数据安全和隐私：P2P 网络中的数据传输可以通过加密和验证机制进行保护，确保数据的安全性和隐私性。

8. 网络拓扑：P2P 网络可以采用不同的拓扑结构，如纯对等网络、超级节点网络和混合网络。这些结构决定了节点之间的连接方式和数据传输路径。

9. NAT 穿越：P2P 协议通常需要解决网络地址转换 (NAT) 的问题，以确保位于不同私有网络中的节点可以直接通信。

10. 应用领域：P2P 协议在多个领域得到广泛应用，如文件共享、流媒体传输、实时通信、区块链等。

需要注意的是，P2P 协议有多种实现和变种，如 BitTorrent、Napster、Gnutella 等。每种实现都可能有自己的特定特点和协议规范，但它们都遵循 P2P 的核心原则和概念。

## p2p 协议里面节点

在 P2P（Peer-to-Peer）协议中，节点指的是网络中的参与者或对等体。**每个节点都是一个独立的计算机或设备**，可以充当客户端和服务器，能够与其他节点进行直接通信和交互。

节点在 P2P 网络中具有以下特征：

1. 网络身份：每个节点在网络中有一个唯一的标识符，可以是一个独特的标识符、地址或密钥。这个标识符用于识别节点并进行节点之间的通信。

2. 数据存储：每个节点都可以存储和管理一些数据，这些数据可以是共享文件、资源、数据库等。节点可以根据自己的能力和目的来决定存储哪些数据，并将其提供给其他节点。

3. 资源提供者和请求者：节点可以充当资源提供者，即共享自己的资源和服务，供其他节点请求和使用。同时，节点也可以是资源的请求者，向其他节点发送请求以获取所需的资源或服务。

4. 路由和中继：节点在 P2P 网络中可以直接与其他节点通信，因此它们可以在网络中进行路由和中继数据。节点之间可以通过直接连接或经由其他节点进行数据传输。

5. 自主管理：节点在 P2P 网络中具有一定的自主性，可以自行决定加入或离开网络，并管理自己的连接和资源。它们可以根据网络拓扑、负载情况等因素来选择与哪些节点进行通信。

6. 功能和角色：每个节点可以根据网络需求和协议规范扮演不同的功能和角色。例如，某些节点可能专注于提供搜索服务、文件共享，而其他节点可能提供计算资源或网络带宽。

总而言之，P2P 协议中的节点是指参与 P2P 网络的独立计算机或设备，它们可以共享资源、提供服务、请求服务，并通过直接通信与其他节点进行交互。节点是 P2P 网络的基本构建块，它们一起形成了一个去中心化的网络结构。

## 能详细说说 ICE 技术吗

当两个设备尝试建立点对点连接时，ICE（Interactive Connectivity Establishment）技术允许它们在不同的网络环境中发现彼此的存在，并解决了 NAT（Network Address Translation）和防火墙的限制。ICE 协议是 WebRTC 中实现对等连接的核心组成部分。

ICE 技术主要包括以下步骤：

1. 候选地址收集：每个设备通过检查其网络接口和配置来收集一组可能的候选地址。这些候选地址是设备可用的网络地址和端口组合，可以是私有地址（如局域网内的地址）或公共地址（如公网 IP 地址）。

2. STUN 服务器：设备会使用 STUN（Session Traversal Utilities for NAT）服务器来确定它们在 NAT 后面的真实地址。设备通过向 STUN 服务器发送请求，获得其外部可见地址和端口，以及 NAT 类型和属性的信息。

3. 候选地址排序：设备根据优先级和类型对候选地址进行排序。候选地址的优先级是根据网络类型、延迟、带宽等因素确定的。常见的候选地址类型包括本地地址、服务器反射地址（STUN 服务器返回的地址）和中继地址（通过 TURN 服务器进行中继）。

4. 连接检查：设备开始与对方设备进行连接检查，以确定哪些候选地址是可达的。设备会尝试使用不同的传输协议（如 UDP 和 TCP）和候选地址对对方设备发送连接请求，然后等待对方设备的响应。

5. NAT 穿透和端口映射：如果设备位于使用 NAT 的网络后面，连接检查的过程可以帮助设备在 NAT 上建立端口映射，使得对方设备可以直接与其通信。这样，设备就能够通过 NAT 穿越并建立点对点连接。

6. 建立连接：当设备发现可达的候选地址并成功进行连接检查时，它们可以确定最佳的可用传输路径和地址，建立点对点连接。一旦连接建立，设备就可以进行实时音频、视频和数据传输。

通过使用 ICE 技术，WebRTC 可以适应各种网络环境，并自动选择和建立最佳的连接路径。它允许设备在不同的网络配置中进行通信，包括对称型 NAT、锥形 NAT、端口限制型 NAT 等情况下的通信。这样，即使设备位于不同的局域网中，也可以通过穿越 NAT 并建立点对点连接，实现实时通信。

## STUN（Session Traversal Utilities for NAT）服务器是什么，是公网的吗

STUN（Session Traversal Utilities for NAT）服务器是一种用于解决网络地址转换（NAT）问题的服务器。它的主要作用是帮助设备确定自己在 NAT 后面的公共 IP 地址和端口，以及了解 NAT 类型和属性的信息。

STUN 服务器通常位于公共互联网上，因此可以被设备在局域网中访问。设备可以通过与 STUN 服务器进行通信，获取其外部可见的公网 IP 地址和端口。这是因为当设备在局域网内时，它们被分配了私有 IP 地址，该地址在互联网上不可直接访问。

设备使用 STUN 协议与 STUN 服务器进行通信。它们发送 STUN 请求到 STUN 服务器，并在响应中获取公网 IP 地址和端口。这些信息将被设备用于与其他设备进行直接通信，以建立点对点连接。

需要注意的是，STUN 服务器本身并不直接参与设备之间的通信，而是提供了一种方法来获取设备的公网地址。设备之间的直接通信是通过候选地址和 ICE（Interactive Connectivity Establishment）协议进行的。

总结起来，STUN 服务器是用于协助设备获取其在 NAT 后面的公网 IP 地址和端口的服务器。它是位于公共互联网上的服务器，可以被局域网中的设备访问。STUN 服务器在 WebRTC 中起到重要作用，帮助设备穿越 NAT，建立点对点连接，实现实时通信。

## webRTC 底层协议是 TCP 还是 UDP，P2P 底层是 TCP 还是 UDP 吗

WebRTC 使用的底层传输协议是 UDP（User Datagram Protocol）。UDP 提供了无连接、低延迟和高吞吐量的特性，适合实时通信应用，如音视频传输。WebRTC 利用 UDP 传输来实现对等之间的实时数据传输，以提供较低的延迟和更好的用户体验。

然而，WebRTC 在底层仍然依赖于 TCP（Transmission Control Protocol）来建立对等连接时的信令交换和 NAT 穿透等功能。通过信令服务器进行交换的 SDP（Session Description Protocol）和 ICE（Interactive Connectivity Establishment）候选地址信息等都是通过 TCP 传输的。这些步骤主要用于建立对等连接所需的协商和配置，一旦连接建立，实际的数据传输将使用 UDP 进行。

至于 P2P（点对点）通信，底层传输协议可以是 TCP 或 UDP，具体取决于应用程序的需求和实现方式。P2P 应用程序可以在 TCP 或 UDP 上构建自己的协议，以实现直接的点对点通信。TCP 提供可靠的数据传输和流控制，适用于需要确保数据完整性和顺序的应用程序。而 UDP 提供了无连接、低延迟和高吞吐量的特性，适合实时性要求较高的应用程序。

总之，WebRTC 使用 UDP 作为底层传输协议来进行实时数据传输，而 P2P 应用程序可以选择使用 TCP 或 UDP，具体取决于应用程序的需求和设计。

## p2p 建立连接步骤

在基于 WebRTC 的 P2P 建立连接过程中，一般会使用 STUN（Session Traversal Utilities for NAT）服务器来协助 NAT 穿越。STUN 服务器主要用于获取本地计算机的公网 IP 和端口信息。

在建立连接之前，两个对等端都需要与 STUN 服务器进行通信。通常的流程如下：

1. Peer A 和 Peer B 各自创建一个 `RTCPeerConnection` 实例。
   常见的预定义 STUN 服务器示例：
   - stun:stun.l.google.com:19302
   - stun:stun1.l.google.com:19302
   - stun:stun2.l.google.com:19302
   - stun:stun3.l.google.com:19302
   - stun:stun4.l.google.com:19302
2. Peer A 和 Peer B 都将 STUN 服务器的地址配置到 ICE 服务器列表中。可以使用预定义的公共 STUN 服务器，如 `stun:stun.services.mozilla.com` 或 `stun:stun.l.google.com:19302`。
3. Peer A 和 Peer B 分别通过 `createOffer()` 方法创建一个 SDP（Session Description Protocol）描述。
4. Peer A 和 Peer B 将自己创建的 SDP 描述通过信令通道（如 WebSocket）发送给对方。
5. 接收到对方的 SDP 描述后，Peer A 和 Peer B 分别使用 `setRemoteDescription()` 方法将对方的 SDP 描述设置为远程描述。
6. Peer A 和 Peer B 分别调用 `createAnswer()` 方法创建自己的应答 SDP 描述。
7. Peer A 和 Peer B 将自己创建的应答 SDP 描述通过信令通道发送给对方。
8. 接收到对方的应答 SDP 描述后，Peer A 和 Peer B 分别使用 `setRemoteDescription()` 方法将对方的应答描述设置为远程描述。
9. Peer A 和 Peer B 通过 ICE（Interactive Connectivity Establishment）框架开始进行 ICE 候选者的收集和交换。这会涉及到通过 STUN 服务器获取本地计算机的公网 IP 和端口信息，并将候选者发送给对方。
10. Peer A 和 Peer B 相互交换 ICE 候选者，直到双方都收集到对方的候选者。
11. Peer A 和 Peer B 分别调用 `addIceCandidate()` 方法将对方的 ICE 候选者添加到本地的候选者列表中。
12. ICE 框架会尝试使用收集到的候选者进行连接，包括**直接连接**、**通过 NAT 穿越**等方式。

通过这个过程，两个对等端能够建立起直接的 P2P 连接，并在连接过程中交换 IP 信息和候选者信息，以便实现穿越 NAT 网络并建立对等连接。STUN 服务器在其中的作用是帮助获取公网 IP 和端口信息，并在 ICE 过程中协助候选者的交换。

## 如果一个已有两个人通过 p2p 连接起来了，再进入第三个人，它们之间的相互连接是如何建立起来的呢

当第三个人加入已有的 P2P 连接时，通常会使用类似的流程来建立与其他两个人的连接。以下是一种可能的流程：

第三个人通过信令服务器获取其他两个人的信息（如 SDP 和 ICE 候选项）。

第三个人创建一个新的 RTCPeerConnection 对象，并设置获取到的远程 SDP 作为远程描述（setRemoteDescription）。

第三个人开始收集自己的 ICE 候选项（onicecandidate 事件）并发送给其他两个人。

其他两个人接收到第三个人的 ICE 候选项后，添加到各自的 RTCPeerConnection（addIceCandidate）。

当 ICE 候选项交换完成后，第三个人创建自己的本地 SDP（createAnswer），并设置为本地描述（setLocalDescription）。

第三个人将自己的本地 SDP 发送给其他两个人。

其他两个人接收到第三个人的本地 SDP 后，设置为远程描述（setRemoteDescription）。

这样，三个人之间的连接就建立起来了。它们可以通过 DataChannel 进行消息传递、音视频通话等操作。

整个过程中，信令服务器起到了中介的作用，协助传递连接建立所需的信息。具体的实现方式和信令协议可能因应用程序的不同而有所差异，但核心思想是通过信令服务器来交换必要的连接信息，以使各个节点能够建立起彼此的直接连接。
