## 后编译

> 后编译的核心在于把编译依赖包的时机延后，并且统一编译
> 主要解决的问题是代码冗余

指的是应用依赖的 NPM 包并不需要在发布前编译，而是随着应用编译打包的时候一块编译。

A 本身需要后编译，然后 A 的依赖包 C 和 D 也需要后编译，这种场景称为**嵌套后编译**

为了解决上述嵌套后编译问题，我们开发了一个 webpack 插件 [webpack-post-compile-plugin](https://www.npmjs.com/package/webpack-post-compile-plugin)，用于自动收集后编译的依赖包以及其嵌套依赖；

### 优点

- 公共的依赖可以实现共用，只此一份，重要的是只编译一次，建议通过 peerDependencies 管理依赖。
- babel 转换 API（例如 babel-plugin-transform-runtime 或者 babel-polyfill）部分的代码只有一份。
- 不用每个依赖包都需要配置编译打包环节，甚至可以直接源码级别发布。

### 缺点

- 主应用的 babel 配置需要能兼容依赖包的 babel 配置。
- 依赖包不能使用 alias、不能方便的使用 DefinePlugin（可以经过一次简单编译，但是不做 babel 处理）。
- 应用编译时间会变长。

## 按需引入

> 用来解决非必要的依赖的问题

按需引入针对的场景主要是**组件库**、**工具类**依赖包。因为不管是组件库还是依赖包，往往都是“大而全”的，而在开发应用的时候，我们可能只是使用了其一部分能力，**如果全部引入的话，会有很多资源浪费**。

为了解决这个问题，我们需要按需引入。目前主流组件库或者工具包也都是提供按需引入能力的，但是基本都是提供对编译后模块引入。

而我们推荐的是对源码的按需引入，配合**后编译**的打包方案。

### 入口

> 现在这个支持已经很丰富了

NPM 包的入口问题，编译后入口依旧使用 `package.json` 中的 `main` 字段，然后源码的入口使用 `module` 字段

### Vue 组件库编译

> 使用插件解决路径问题 ✨✨✨✨✨

**后编译**和**按需引入**一个最最典型的场景就是我们的组件库，这里分享下我们对于组件库（基于 Vue）的实践经验。

按需引入，在没有后编译的时候，其实我们已经实现了在编译发布的时候直接做到自动根据各模块分别编译，这样使用方就可以直接引入对应目录的入口文件。这个原理很简单：遍历源码目录下的模块目录，得到各个入口，动态修改了组件库 webpack 配置的入口。而这个过程在**后编译**场景中就不存在了，可以直接引入到源码所对应的模块入口，因为**后编译**不需要依赖包自己编译，只需要应用去编译就好了。

对于组件而言，如果是前编译的话，一般我们会编译出入口 JS 文件，以及样式 CSS 文件，这样如果来实现按需引入的话，可能是这样的：

```js
import Dialog from 'cube-ui/lib/dialog'
import 'cube-ui/lib/dialog/style.css'
```

即使是在**后编译**场景下，虽然不需要处理样式问题了，但是还是会遇到按需引入的时候，路径不够优雅：

```js
import Dialog from 'cube-ui/src/modules/dialog'
```

以上不管是哪种，总是不够优雅，幸好有一个 babel 插件 `babel-plugin-transform-imports` 来帮助我们优雅的按需引入。但是对于我们编译后的场景，还需要引入样式，为此，我们对其做了统一，在 `babel-plugin-transform-imports` 上做了增强的 `babel-plugin-transform-modules` 插件，增设了 `style` 配置项。
所以不管是不是使用了**后编译**，我们想要做到按需引入，只需要：

```js
import { Dialog } form 'cube-ui'
```

这样写就可以了，如果你是使用的后编译，直接引入的是源码，那么只需要在 .babelrc 文件中增加如下配置：

```js
{
    "plugins": [
["transform-modules", {
"cube-ui": {
"transform": "cube-ui/src/modules/${member}",
"preventFullImport": true,
"kebabCase": true
}
}]
]
}
```

而如果是 webpack 1 或者说使用的组件库是已经编译后的，那只需要增设 `style` 配置项即可：

```js
{
    "plugins": [
["transform-modules", {
"cube-ui": {
"transform": "cube-ui/lib/${member}",
"preventFullImport": true,
"kebabCase": true,
"style": true
}
}]
]
}
```

这样我们就通过一个插件实现了优雅的按需引入，不管是不是使用了后编译，对于开发者而言只需要修改下 babel 的配置即可，而不需要大肆去修改源码中的引入路径。

## Reading list

- https://juejin.cn/post/6844903502586593288
- https://github.com/rollup/rollup/wiki/pkg.module
- https://www.npmjs.com/package/babel-plugin-transform-modules
- https://www.npmjs.com/package/babel-plugin-transform-imports
