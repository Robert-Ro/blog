# 语言特性

> [原文链接](https://time.geekbang.org/column/article/104071)

## JIT 与 AOT

借助于先进的工具链和编译器，Dart 是少数同时支持 JIT（Just In Time，即时编译）和 AOT（Ahead of Time，运行前编译）的语言之一。那，到底什么是 JIT 和 AOT 呢？

语言在运行之前通常都需要编译，JIT 和 AOT 则是最常见的两种编译模式。

- JIT 在**运行时即时编译**，在开发周期中使用，可以动态下发和执行代码，开发测试效率高，但运行速度和执行性能则会因为运行时即时编译受到影响。
- AOT 即**提前编译**，可以生成被直接执行的二进制代码，运行速度快、执行性能表现好，但每次执行前都需要提前编译，开发测试效率低。

总结来讲，在开发期使用 JIT 编译，可以缩短产品的开发周期。Flutter 最受欢迎的功能之一热重载，正是基于此特性。而在发布期使用 AOT，就不需要像 React Native 那样在跨平台 JavaScript 代码和原生 Android、iOS 代码之间建立低效的方法调用映射关系。所以说，**Dart 具有运行速度快、执行性能好的特点**。

那么，如何区分一门语言究竟是 AOT 还是 JIT 呢？通常来说，看代码在执行前是否需要编译即可。如果需要编译，通常属于 AOT；如果不需要，则属于 JIT。

AOT 的典型代表是 **C/C++**，它们必须在执行前编译成机器码；而 JIT 的代表，则包括了如 JavaScript、Python 等几乎所有的脚本语言。

Java 主要使用 JIT 编译模式来实现高性能。Java 程序在运行时，通过 Java 虚拟机（JVM）上的 JIT 编译器将字节码（Bytecode）编译成特定平台的机器码。这种编译方式允许 Java 程序在运行时进行优化，例如，通过即时优化（Just-In-Time Optimization）来提高性能。

然而，Java 也可以使用 AOT 编译技术。近年来，Java 发展了一些 AOT 编译器，如 GraalVM 的 Ahead-Of-Time Compiler，它能够在运行前将 Java 字节码编译成机器码。这种编译方式可以提高程序的启动速度和运行时性能，尤其是在那些对启动时间有严格要求的场景中。

此外，Android 平台上的 Android Runtime (ART) 使用了一种类似于 AOT 的机制，它在应用安装时将 Dalvik 字节码预编译成机器码，这个过程称为预先编译（Precompilation）。

总结来说，Java 传统上以 JIT 编译模式为主，但也支持 AOT 编译，尤其是在需要优化启动时间和运行性能的场景中。随着 JVM 技术的发展，AOT 编译在 Java 生态系统中的使用可能会变得更加普遍。

## 内存分配与垃圾回收

Dart VM 的内存分配策略比较简单，创建对象时只需要在堆上移动指针，内存增长始终是线性的，省去了查找可用内存的过程。

在 Dart 中，并发是通过 Isolate 实现的。Isolate 是类似于线程但不共享内存，独立运行的 worker。这样的机制，就可以让 Dart 实现无锁的快速分配。

Dart 的垃圾回收，则是采用了多生代算法。新生代在回收内存时采用“半空间”机制，触发垃圾回收时，Dart 会将当前半空间中的“活跃”对象拷贝到备用空间，然后整体释放当前空间的所有内存。回收过程中，Dart 只需要操作少量的“活跃”对象，没有引用的大量“死亡”对象则被忽略，这样的回收机制很适合 Flutter 框架中大量 Widget 销毁重建的场景。

## 单线程模型

支持并发执行线程的高级语言（比如，C++、Java、Objective-C），大都以抢占式的方式切换线程，即：每个线程都会被分配一个固定的时间片来执行，超过了时间片后线程上下文将被抢占后切换。如果这时正在更新线程间的共享资源，抢占后就可能导致数据不同步的问题。

解决这一问题的典型方法是，使用锁来保护共享资源，但锁本身又可能会带来性能损耗，甚至出现死锁等更严重的问题。

这时，Dart 是单线程模型的优势就体现出来了，因为它天然不存在资源竞争和状态同步的问题。这就意味着，一旦某个函数开始执行，就将执行到这个函数结束，而不会被其他 Dart 代码打断。所以，**Dart 中并没有线程，只有 Isolate（隔离区）**。Isolates 之间不会共享内存，就像几个运行在不同进程中的 worker，通过事件循环（Event Looper）在事件队列（Event Queue）上传递消息通信。

## 无需单独的声明式布局语言

在 Flutter 中，界面布局直接通过 Dart 编码来定义。Dart 声明式编程布局易于阅读和可视化，使得 Flutter 并不需要类似 JSX 或 XML 的声明式布局语言。所有的布局都使用同一种格式，也使得 Flutter 很容易提供高级工具使布局更简单。开发过程也不需要可视化界面构建器，因为热重载可以让我们立即在手机上看到运行效果。
